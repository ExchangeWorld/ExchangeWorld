<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>routers/authenticate.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">undefined: routers/authenticate.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/Authenticate.html">Authenticate</a></li>
                            <li><a href="../classes/Chatroom.html">Chatroom</a></li>
                            <li><a href="../classes/Comment.html">Comment</a></li>
                            <li><a href="../classes/Exchange.html">Exchange</a></li>
                            <li><a href="../classes/Follow.html">Follow</a></li>
                            <li><a href="../classes/Goods.html">Goods</a></li>
                            <li><a href="../classes/Message.html">Message</a></li>
                            <li><a href="../classes/Notification.html">Notification</a></li>
                            <li><a href="../classes/Queue.html">Queue</a></li>
                            <li><a href="../classes/Search.html">Search</a></li>
                            <li><a href="../classes/Star.html">Star</a></li>
                            <li><a href="../classes/Upload.html">Upload</a></li>
                            <li><a href="../classes/User.html">User</a></li>
                    </ul>
                </div>
            </div>
            
            <div id="elements" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Elements</h2>
                </div>
                <div class="bd">
                    <ul>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>routers/<ul><li><a href="../files/routers_authenticate.js.html">authenticate.js</a></li><li><a href="../files/routers_chatroom.js.html">chatroom.js</a></li><li><a href="../files/routers_comment.js.html">comment.js</a></li><li><a href="../files/routers_exchange.js.html">exchange.js</a></li><li><a href="../files/routers_follow.js.html">follow.js</a></li><li><a href="../files/routers_goods.js.html">goods.js</a></li><li><a href="../files/routers_goods.search.js.html">goods.search.js</a></li><li><a href="../files/routers_message.js.html">message.js</a></li><li><a href="../files/routers_notification.js.html">notification.js</a></li><li><a href="../files/routers_queue.js.html">queue.js</a></li><li><a href="../files/routers_star.js.html">star.js</a></li><li><a href="../files/routers_upload.js.html">upload.js</a></li><li><a href="../files/routers_user.js.html">user.js</a></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>routers/authenticate.js</h4>

<pre class="code prettyprint linenums">
/**
 * Provides some methods related to any authentications
 *
 * @class Authenticate
 */

&#x27;use strict&#x27;;

var path = require(&#x27;path&#x27;);
var crypto = require(&#x27;crypto&#x27;);

var express = require(&#x27;express&#x27;);
var sec_ran = require(&#x27;secure-random&#x27;);
var validator = require(&#x27;validator&#x27;);
var redis = require(path.resolve(__dirname, &#x27;../libs/redis&#x27;));
var router = express.Router();

// Including tables
var users = require(path.resolve(__dirname, &#x27;../ORM/Users&#x27;));
var auths = require(path.resolve(__dirname, &#x27;../ORM/Auths&#x27;));

// Hashcode generation functions
var getSHA256 = strToEncrypt =&gt; {
	var sha256 = crypto.createHash(&#x27;sha256&#x27;);
	sha256.update(strToEncrypt, &#x27;utf8&#x27;);
	return sha256.digest(&#x27;hex&#x27;);
};

// Faster
var getSHA1 = strToEncrypt =&gt; {
	var sha1 = crypto.createHash(&#x27;sha1&#x27;);
	sha1.update(strToEncrypt, &#x27;utf8&#x27;);
	return sha1.digest(&#x27;hex&#x27;);
};


// Token expire time
const TOKEN_EXPIRE_TIME = 604800;

/**
 * Register a new user
 *
 * @method POST api/authenticate/register
 * @param  {Boolean=false} fb If the registeration is with FB
 * @param  {String} identity The user ID. If it&#x27;s with FB, fb_id as identity
 * @param  {String=&#x27;&#x27;} password Password. If it&#x27;s with FB, password will be generated by hash
 * @param  {String} name The displaying name
 * @param  {String=&#x27;&#x27;} email The email
 * @param  {String=&#x27;&#x27;} photo_path The photo path of user face photo
 * @return {JSON} New created user object
 */
router.post(&#x27;/register&#x27;, (req, res) =&gt; {
	var _tmpfb = (req.body.fb || &#x27;&#x27;);
	var _fb = (_tmpfb === &#x27;true&#x27; || _tmpfb === true);
	var _id = req.body.identity || &#x27;&#x27;;
	var _password = req.body.password || &#x27;&#x27;;
	var _name = req.body.name || &#x27;&#x27;;
	var _email = req.body.email || &#x27;&#x27;;
	var _photo_path = req.body.photo_path || &#x27;&#x27;;

	// Create password for fb
	if (_fb === true) {
		var id_length = _id.length;
		_password = getSHA256(_id.substring(id_length - 2, id_length) + &#x27; and this is still a fucking hash with &#x27; + _id.substring(0, id_length - 2));
	}

	// Check if the _password is not valid
	if (_password.length &lt; 4) {
		res.status(400).json({
			error: &#x27;Password must be specified and it must contain at least 4 characters&#x27;
		});

		return;
	}

	// Check if the _id is not valid
	if (_id === &#x27;&#x27;) {
		res.status(400).json({
			error: &#x27;ID must be specified&#x27;
		});

		return;
	}

	// Check if the _id is not valid
	if (_name === &#x27;&#x27;) {
		res.status(400).json({
			error: &#x27;Name must be specified&#x27;
		});

		return;
	}

	// Check Email
	if (_email !== &#x27;&#x27; &amp;&amp; validator.isEmail(_email) === false) {
		res.status(400).json({
			error: &#x27;Email is wrong&#x27;
		});

		return;
	}

	// Create user instance
	users
		.create({
			identity: _id,
			name: _name,
			email: _email,
			photo_path: _photo_path
		})
		.then(result =&gt; {
			var _salt = JSON.stringify(sec_ran.randomArray(7));

			var _answer = getSHA256(_password + &#x27; and this is a fucking hash with &#x27; + _salt);

			auths
				.create({
					user_identity: _id,
					salt: _salt,
					answer: _answer,
					user_uid: result.uid
				})
				.catch(err =&gt; {
					res.status(500).json({
						error: err
					});
				});

			return result;
		})
		.then(result =&gt; {
			res.status(201).json(result);
		})
		.catch(err =&gt; {
			res.status(500).json({
				error: err
			});
		});
});

/**
 * Login
 *
 * @method POST api/authenticate/login
 * @param  {Boolean=false} fb If the login is with FB
 * @param  {String} identity The user ID. If it&#x27;s with FB, fb_id as identity
 * @param  {String=&#x27;&#x27;} password Password. If it&#x27;s with FB, password will be checked by hash
 * @return {JSON} Token
 * @example
&lt;pre&gt;
{
	authentication: &#x27;success&#x27;,
	token: token
}
&lt;/pre&gt;
 * @example
&lt;pre&gt;
{
	authentication: &#x27;fail&#x27;,
	token: null
}
&lt;/pre&gt;
 */
var login_function = (req, res) =&gt; {
	var _tmpfb = (req.body.fb || &#x27;&#x27;);
	var _fb = (_tmpfb === &#x27;true&#x27; || _tmpfb === true);
	var _id = req.body.identity;
	var _password = req.body.password || &#x27;&#x27;;

	if (!_id) {
		res.status(400).json({
			error: &#x27;identity not given&#x27;
		});
		return;
	}

	if (_fb === true) {
		var id_length = _id.length;
		_password = getSHA256(_id.substring(id_length - 2, id_length) + &#x27; and this is still a fucking hash with &#x27; + _id.substring(0, id_length - 2));
	}

	auths
		.findOne({
			where: {
				user_identity: _id
			}
		})
		.then(test_user =&gt; {
			if (test_user !== undefined &amp;&amp; test_user !== null &amp;&amp; getSHA256(_password + &#x27; and this is a fucking hash with &#x27; + test_user.salt) === test_user.answer) {
				return test_user;
			}

			return &#x27;not a user&#x27;;
		})
		.then(test_user =&gt; {
			if (test_user === &#x27;not a user&#x27; || test_user.user_uid === null) {
				res.status(401).json({
					authentication: &#x27;fail&#x27;,
					token: null
				});
			} else {
				var _salt = JSON.stringify(sec_ran.randomArray(7));
				var tmpToken = getSHA1(test_user.user_identity + _salt);

				redis.pipeline().set(tmpToken, test_user.user_uid).expire(tmpToken, TOKEN_EXPIRE_TIME).exec((err, result) =&gt; {
					if (err) {
						res.status(500).json({
							error: err
						});
					} else if (result[0][0] || result[1][0]) {
						res.status(500).json({
							error: [result[0][0], result[1][0]]
						});
					} else {
						res.status(201).json({
							authentication: &#x27;success&#x27;,
							token: tmpToken
						});
					}
				});
			}
		})
		.catch(err =&gt; {
			res.status(500).json({
				error: err
			});
		});
};
router.post(&#x27;/login&#x27;, login_function);

/**
 * Token validation
 *
 * @method GET *?token=...
 * @param  {String=&#x27;&#x27;} TOKEN
 * @return {JSON|Nothing} If failed, return JSON
 * @example
&lt;pre&gt;
{
	authentication: &#x27;fail&#x27;,
	token: null
}
&lt;/pre&gt;
 */
var token_function = (req, res, next) =&gt; {
	var _token = req.query.token || &#x27;&#x27;;

	if (_token === &#x27;&#x27;) {
		// EXWD middleware &gt;w&lt;
		req.exwd = {
			admin: false,
			anonymous: true,
			uid: -1,
			registered: false
		};

		next();
	} else {
		redis.get(_token, (err, result) =&gt; {
			if (err) {
				res.status(500).json({
					error: err
				});
			} else if (result === null) {
				// EXWD middleware &gt;w&lt;
				req.exwd = {
					admin: false,
					anonymous: true,
					uid: -1,
					registered: false
				};

				next();
			} else {
				redis.pipeline().set(_token, result).expire(_token, TOKEN_EXPIRE_TIME).exec((err, res) =&gt; {
					if (err) {
						res.status(500).json({
							error: err
						});
					} else {
						// EXWD middleware &gt;w&lt;
						req.exwd = {
							admin: false,
							anonymous: false,
							uid: parseInt(result, 10),
							registered: true
						};

						next();
					}
				});
			}
		});
	}
};
router.get(&#x27;/&#x27;, token_function);
router.get(&#x27;/check&#x27;, token_function, (req, res) =&gt; {
	if (req.exwd.registered) {
		res.status(200).json({
			status: &#x27;alive&#x27;,
			token: req.query.token
		});
	} else {
		res.status(410).json({
			status: &#x27;dead&#x27;,
			token: null
		});
	}
});

module.exports = {
	router: router,
	login: login_function,
	token: token_function
};

</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
